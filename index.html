<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥è¯­å•è¯æ¶ˆæ¶ˆä¹</title>
    <style>
        body {
            background-color: #ffebee;
            font-family: "é»‘ä½“", sans-serif;
            text-align: center;
            margin: 0;
            padding: 10px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        #gameContainer {
            margin: 10px auto;
            max-width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .word-box {
            background-color: #f8bbd0;
            border: 2px solid #f48fb1;
            border-radius: 10px;
            width: calc(50% - 15px);
            height: 70px;
            margin: 5px;
            line-height: 70px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }
        .selected {
            background-color: #f06292;
            transform: scale(1.05);
            color: white;
        }
        .matched {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #controls {
            margin: 10px;
            padding: 10px;
            background-color: #fce4ec;
            border-radius: 10px;
        }
        button, select, input {
            background-color: #f48fb1;
            border: none;
            padding: 8px 15px;
            margin: 4px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            width: auto;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        #timer, #score, #lessonInfo {
            font-size: 18px;
            margin: 8px;
            color: #ad1457;
        }
        h1 {
            color: #880e4f;
            font-size: 24px;
            margin: 10px 0;
        }
        #leaderboard {
            background-color: #fce4ec;
            border-radius: 10px;
            padding: 10px;
            margin: 15px auto;
            max-width: 100%;
        }
        #leaderboard h2 {
            color: #880e4f;
            margin-top: 0;
            font-size: 20px;
        }
        #leaderboard ol {
            text-align: left;
            padding-left: 20px;
        }
        #leaderboard li {
            margin: 5px 0;
            font-size: 16px;
        }
        .leaderboard-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 15px;
        }
        .leaderboard-section {
            flex: 1;
            min-width: 280px;
            background-color: #f8bbd0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .leaderboard-title {
            font-weight: bold;
            margin: 8px 0;
            color: #880e4f;
            text-align: center;
            font-size: 18px;
        }
        
        /* ç§»åŠ¨ç«¯ç‰¹å®šæ ·å¼ */
        @media (max-width: 480px) {
            .word-box {
                width: calc(50% - 10px);
                height: 60px;
                line-height: 60px;
                font-size: 14px;
            }
            button, select, input {
                padding: 6px 12px;
                font-size: 13px;
            }
            #studentName {
                width: 120px;
            }
        }
    </style>
</head>
<body>
    <h1>æ—¥è¯­å•è¯æ¶ˆæ¶ˆä¹</h1>
    <div id="controls">
        <input type="text" id="studentName" placeholder="è¾“å…¥å­¦ç”Ÿå§“å" style="width: 140px;">
        <button id="startBtn">é–‹å§‹</button>
        <button id="endBtn">çµ‚äº†</button>
        <select id="lesson">
            <option value="lesson7">ç¬¬7è¯¾</option>
            <option value="lesson8">ç¬¬8è¯¾</option>
            <option value="lesson9">ç¬¬9è¯¾</option>
        </select>
        <select id="group">
            <option value="1">å‘éŸ³å¯¹ç…§ç»„</option>
            <option value="2">æ„æ€å¯¹ç…§ç»„</option>
            <option value="3">å¤§æ‚çƒ©ç»„</option>
        </select>
        <div id="lessonInfo"></div>
        <div id="timer">æ®‹ã‚Šæ™‚é–“: 0ç§’</div>
        <div id="score">å¾—ç‚¹: 0</div>
    </div>
    <div id="gameContainer"></div>

    <div id="leaderboard">
        <h2>ğŸ† æˆç»©æ’è¡Œæ¦œ</h2>
        <button id="clearLeaderboardBtn">æ¸…ç©ºæ’è¡Œæ¦œ</button>
        <div id="leaderboardList" class="leaderboard-container">
            <!-- æ’è¡Œæ¦œå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        let currentPairs = [];
        let selected = [];
        let score = 0;
        let timer;
        let timeLeft = 0;
        let currentLesson = '';
        let currentGroup = '';
        let studentName = '';
        
        // åˆå§‹åŒ–æ’è¡Œæ¦œ
        let leaderboard = JSON.parse(localStorage.getItem('wordGameLeaderboard')) || [];
        updateLeaderboard();

        // ä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨æ›¿ä»£onclickå±æ€§
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('endBtn').addEventListener('click', endGame);
        document.getElementById('clearLeaderboardBtn').addEventListener('click', clearLeaderboard);

        const wordData = {
            lesson7: {
                groups: [
                    // ç¬¬7è¯¾å‘éŸ³å¯¹ç…§ç»„(27ä¸ªå•è¯)
                    ['ãã†ã˜|æƒé™¤', 'ã—ã¿ã‚“|å¸‚æ°‘', 'ãŠã¨ãª|å¤§äºº', 'ããŸã‚„ã¾|åŒ—å±±', 'ã‚ã¤ã¾ã‚‹|é›†ã¾ã‚‹', 
                     'ãŠã‚Šã‚‹|é™ã‚Šã‚‹', 'ã²ã‚ã†|æ‹¾ã†', 'ã™ã¦ã‚‹|æ¨ã¦ã‚‹', 'ã•ã‚“ã‹|å‚åŠ ', 'ã¡ã‚…ã†ãŒãã›ã„|ä¸­å­¦ç”Ÿ',
                     'ãªã‚‹|æˆã‚‹', 'ã‹ã‚“|ç¼¶', 'ã³ã‚“|ç“¶', 'ããŸãªã„|æ±šã„', 'ã«ãŠã„|åŒ‚ã„','ã¤ã‹ã‚Œã‚‹|ç–²ã‚Œã‚‹',
                     'ãªããªã‚‹|ç„¡ããªã‚‹', 'ã¨ãŠã‚‹|é€šã‚‹', 'ã¨ã¡ã‚…ã†|é€”ä¸­', 'ã„ã‚„|å«Œ', 'ãµãã‚|è¢‹','ã¯ã“|ç®±',
                     'ã—ã‚‹|çŸ¥ã‚‹', 'ã—ã‚‡ã†ã¡ã‚…ã†ãŒãã›ã„|å°ä¸­å­¦ç”Ÿ','ã•ã‚€ã„|å¯’ã„','ã‚ãŸãŸã‹ã„|æš–ã‹ã„',
                     'ã™ã‚€|ä½ã‚€'], 
                    // ç¬¬7è¯¾æ„æ€å¯¹ç…§ç»„(20ä¸ªå•è¯)
                    ['ã¾ã |è¿˜ï¼Œå°šæœª', 'ãœã²|ä¸€å®šï¼ŒåŠ¡å¿…', 'é™ã‚Šã‚‹|ä¸‹æ¥', 'é€šã‚‹|é€šè¿‡', 'ãã—ã¦|ç„¶åï¼Œè€Œä¸”',
                     'ç¼¶|ç½å­', 'ãƒ“ãƒ‹ãƒ¼ãƒ«|å¡‘æ–™', 'ã„ã‚„|è®¨åŒ', 'åŒ‚ã„|æ°”å‘³', 'ãªããªã‚‹|ä¸¢å¤±ï¼Œæ¶ˆå¤±',
                     'ãŠã¨ãª|å¤§äºº', 'ãŠã¨ã¨ã„|å‰å¤©', 'ã‚ã•ã£ã¦|åå¤©','ã²ãŒã—|ä¸œ','ã«ã—|è¥¿','ã†ãˆ|ä¸Š',
                     'åŒ¹|å°åŠ¨ç‰©å•ä½', 'æš|æ‰å¹³ç‰©å•ä½', 'å°|æœºæ¢°ç±»å•ä½', 'ã•ã‚€ã„|å¯’å†·', 'ã‚ãŸãŸã‹ã„|æš–å’Œ'],
                    // ç¬¬7è¯¾æ··æ­ç»„(42ä¸ªå•è¯)
                    ['ãã†ã˜|æƒé™¤', 'ã—ã¿ã‚“|å¸‚æ°‘', 'ãŠã¨ãª|å¤§äºº', 'ããŸã‚„ã¾|åŒ—å±±', 'ã‚ã¤ã¾ã‚‹|é›†ã¾ã‚‹', 
                     'ã²ã‚ã†|æ‹¾ã†', 'ã™ã¦ã‚‹|æ¨ã¦ã‚‹', 'ã•ã‚“ã‹|å‚åŠ ', 'ã¡ã‚…ã†ãŒãã›ã„|ä¸­å­¦ç”Ÿ',
                     'ãªã‚‹|æˆã‚‹', 'ã³ã‚“|ç“¶', 'ããŸãªã„|æ±šã„', 'ã«ãŠã„|åŒ‚ã„','ã¤ã‹ã‚Œã‚‹|ç–²ã‚Œã‚‹',
                     'ã¨ãŠã‚‹|é€šã‚‹', 'ã¨ã¡ã‚…ã†|é€”ä¸­', 'ã„ã‚„|å«Œ', 'ãµãã‚|è¢‹','ã¯ã“|ç®±',
                     'ã—ã‚‹|çŸ¥ã‚‹', 'ã—ã‚‡ã†ã¡ã‚…ã†ãŒãã›ã„|å°ä¸­å­¦ç”Ÿ','ã•ã‚€ã„|å¯’ã„','ã‚ãŸãŸã‹ã„|æš–ã‹ã„',
                     'ã™ã‚€|ä½ã‚€','ã¾ã |è¿˜ï¼Œå°šæœª', 'ãœã²|ä¸€å®šï¼ŒåŠ¡å¿…', 'é™ã‚Šã‚‹|ä¸‹æ¥', 'ãã—ã¦|ç„¶åï¼Œè€Œä¸”',
                     'ç¼¶|ç½å­', 'ãƒ“ãƒ‹ãƒ¼ãƒ«|å¡‘æ–™', 'åŒ‚ã„|æ°”å‘³', 'ãªããªã‚‹|ä¸¢å¤±ï¼Œæ¶ˆå¤±','é™ã‚‹|ä¸‹é›¨ï¼Œä¸‹é›ª',
                     'ãŠã¨ãª|å¤§äºº', 'ãŠã¨ã¨ã„|å‰å¤©', 'ã‚ã•ã£ã¦|åå¤©','ã²ãŒã—|ä¸œ','ã«ã—|è¥¿','ã†ãˆ|ä¸Š',
                     'åŒ¹|å°åŠ¨ç‰©å•ä½', 'æš|æ‰å¹³ç‰©å•ä½', 'å°|æœºæ¢°ç±»å•ä½'],
                ],
                time: 100
            },
            lesson8: {
                groups: [
                    // ç¬¬8è¯¾ç¬¬1ç»„(15ä¸ªå•è¯)
                    ['ã¨ãã„|å¾—æ„', 'ã‚Šã‚‡ã†ã‚Š|æ–™ç†', 'ã‹ã‚‰ã„|è¾›ã„', 'ã¡ã‚‡ã£ã¨|æœ‰ç‚¹', 'ã‚†ã†ã‚ã„|æœ‰å',
                     'ã¯ã˜ã‚ã¦|åˆã‚ã¦', 'ã¾ãªã¶|å­¦ã¶', 'ãƒã‚¹ã‚¿ãƒ¼|æµ·æŠ¥', 'ãƒˆãƒãƒˆ|è¥¿çº¢æŸ¿', 'ãŸã¾ã”|é¸¡è›‹',
                     'ã„ãŸã‚ã‚‚ã®|ç‚’ã‚ç‰©', 'ãˆã„ã‚ˆã†|æ „é¤Š', 'ãŸã£ã·ã‚Š|å……è¶³', 'ã„ã‚|é¢œè‰²', 'ã¨ãã¡ã‚‡ã†|ç‰¹å¾´'],
                    // ç¬¬8è¯¾ç¬¬2ç»„(15ä¸ªå•è¯)
                    ['ãƒ”ãƒ¼ãƒãƒ³|é’æ¤’', 'ã¶ãŸã«ã|è±šè‚‰', 'ãŸã‚“ã±ãè³ª|è›‹ç™½è´¨', 'ãƒ“ã‚¿ãƒŸãƒ³|ç»´ä»–å‘½', 'ã»ã†ãµ|è±Šå¯Œ',
                     'ã‚ã†ã©ã†|åŠ´åƒ', 'ã•ã„ã—ã‚‡|æœ€åˆ', 'ã‹ãŸã„|ç¡¬ã„', 'ã—ãŠã‹ã‚‰ã„|å¡©è¾›ã„', 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹|å»ºè®®',
                     'ã‚„ã£ã¨|ç»ˆäº', 'ã›ã„ã“ã†|æˆåŠŸ', 'ã—ã‚‡ãã–ã„|é£Ÿæ', 'ã‹ã—ã‚…|æ­Œæ‰‹', 'ã›ã‹ã„|ä¸–ç•Œ'],
                    // ç¬¬8è¯¾ç¬¬3ç»„(15ä¸ªå•è¯)
                    ['ã„ã¡ã°ã‚“|ä¸€ç•ª', 'ã„ã‚“ã—ã‚‡ã†|å°è±¡', 'ã®ã“ã‚‹|æ®‹ã‚‹', 'ã‘ã‚“ãŒã|è¦‹å­¦', 'ã¤ã‹ã†|ä½¿ã†',
                     'ã‹ã‚“ãŒãˆã‚‹|è€ƒãˆã‚‹', 'ãŠã—ãˆã‚‹|æ•™ãˆã‚‹', 'ã—ã‹ãŸ|ä»•æ–¹', 'ã„ãã‚‰|å¤šå°‘é’±', 'ã¤ã|ç€ã',
                     'ã‚¹ãƒãƒ¼ãƒ„|è¿åŠ¨', 'ã“ã‚“ã—ã‚…ã†|ä»Šé€±', 'ã“ã‚“ã°ã‚“|ä»Šæ™©', 'ã›ã¤ã‚ã„|èª¬æ˜', 'ã•ã„ã”|æœ€å¾Œ']
                ],
                time: 100
            },
            lesson9: {
                groups: [
                    // ç¬¬9è¯¾ç¬¬1ç»„(22ä¸ªå•è¯)
                    ['ã„ã‚ã„ã‚|å¤šç§å¤šæ ·', 'ã—ã”ã¨|ä»•äº‹', 'ãŠã˜ã‚ƒã¾|ãŠé‚ªé­”', 'ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢|ä¸»æ„', 'ãŠã‚„|çˆ¶æ¯', 
                     'ã¯ãªã—|è©±ã—', 'ã‚Šã‚‡ã†ã—ã‚“|ä¸¡è¦ª', 'ã—ã‚…ãµ|ä¸»å©¦', 'ã‹ã„ã—ã‚ƒã„ã‚“|ä¼šç¤¾å‘˜', 'ã†ãŸ|æ­Œ',
                     'ã†ã‚“ã¦ã‚“ã—ã‚…|é‹è»¢æ‰‹', 'ã‹ã‚“ã”ã—|çœ‹è­·å¸«', 'ãŸã™ã‘ã‚‹|å¸®åŠ©', 'ã˜ã¶ã‚“|è‡ªåˆ†', 'ã¾ãš|é¦–å…ˆ',
                     'ãªã„ã‚ˆã†|å†…å®¹', 'ã‚ˆã®ãªã‹|ä¸–ã®ä¸­', 'ã¾ã‚ã‚Š|å‘¨ã‚Š', 'ã‘ã„ã•ã¤ã‹ã‚“|è­¦å¯Ÿå®˜', 'ã“ã†ã°ã‚“|äº¤ç•ª',
                     'ã¯ãŸã‚‰ã|åƒã', 'ã˜ã‚…ã†ã¿ã‚“|ä½æ°‘'],
                    // ç¬¬9è¯¾ç¬¬2ç»„(22ä¸ªå•è¯)
                    ['ãã†ã ã‚“|ç›¸è«‡', 'ãƒˆãƒ©ãƒ–ãƒ«|çº çº·', 'ã˜ã“|äº‹æ•…', 'ãŸã„ãŠã†|å¯¾å¿œ', 'ã‚ã‚“ãœã‚“|å®‰å…¨',
                     'ã¾ã‚‚ã‚‹|å®ˆã‚‹', 'ãã—ã‚ƒ|è¨˜è€…', 'ã’ã‚“ã°|ç¾å ´', 'ã˜ã‚‡ã†ãã‚‡ã†|çŠ¶æ³', 'ã»ã†ã©ã†|å ±é“',
                     'ãŸã„ã¸ã‚“|å¤§å¤‰', 'ã‚ã¶ãªã„|å±ãªã„', 'ã¨ã“ã‚|æ‰€', 'ã˜ã‘ã‚“|äº‹ä»¶', 'ã“ããªã„ãŒã„|å›½å†…å¤–',
                     'ã•ã¾ã–ã¾|å„ç§å„æ ·', 'ã§ãã”ã¨|å‡ºæ¥äº‹', 'ã™ãã«|é©¬ä¸Š', 'ã‚ã‹ã‚‹|åˆ†ã‹ã‚‹', 'ã¯ã„ãŸã¤|é…é”',
                     'ã°ã‚“|æ™©', 'ã«ã‚‚ã¤|è·ç‰©'],
                    // ç¬¬9è¯¾ç¬¬3ç»„(22ä¸ªå•è¯)
                    ['ã‹ã‚“ã˜ã‚ƒ|æ‚£è€…', 'ã¨ã©ã‘ã‚‹|å±Šã‘ã‚‹', 'ãŠã¨ã—ã‚ˆã‚Š|ãŠå¹´å¯„ã‚Š', 'ã“ã‚|ç±³', 'ãŠã‚‚ã„|é‡ã„',
                     'ã›ã„ã‹ã¤|ç”Ÿæ´»', 'ã‚„ãã ã¤|å½¹ç«‹ã¤', 'ã‚„ã‚ŠãŒã„|ä»·å€¼', 'ã©ã†|æ€æ ·', 'ã—ã‚“ã­ã‚“|æ–°å¹´',
                     'ãŠã¡ã‚ƒ|ãŠèŒ¶', 'ã¤ã‚ãŸã„|å†·ãŸã„', 'ã®ã¿ã‚‚ã®|é£²ã¿ç‰©', 'ã‚‰ã„ã—ã‚…ã†|æ¥é€±', 'ã¯ã£ã´ã‚‡ã†|ç™ºè¡¨',
                     'ã—ã‚“ã¶ã‚“|æ–°è', 'ã‹ã„ã|ä¼šè­°', 'ã‹ã„ã—ã‚ƒ|ä¼šç¤¾', 'ã‚‰ã„ã’ã¤|æ¥æœˆ', 'ã‚Œã„ãã†ã“|å†·è”µåº«',
                     'ã¾ã¡ãŒãˆã‚‹|é–“é•ãˆã‚‹', 'ã¶ã‚“ã—ã‚‡ã†|æ–‡ç« ']
                ],
                time: 100
            }
        };

        function startGame() {
            studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');
                return;
            }
            
            endGame();
            currentLesson = document.getElementById('lesson').value;
            currentGroup = document.getElementById('group').value;
            const groupIndex = parseInt(currentGroup) - 1;
            
            // ä»å½“å‰è¯¾ç¨‹ç»„ä¸­éšæœºé€‰æ‹©16ä¸ªå•è¯(å¦‚æœä¸è¶³16ä¸ªåˆ™å…¨é€‰)
            const allWords = [...wordData[currentLesson].groups[groupIndex]];
            const selectedWords = shuffle(allWords).slice(0, Math.min(16, allWords.length));
            
            currentPairs = [];
            selectedWords.forEach(pair => {
                const [kana, meaning] = pair.split('|');
                currentPairs.push({kana, meaning});
            });
            
            createGameBoard();
            timeLeft = wordData[currentLesson].time;
            score = 0;
            updateScore();
            updateLessonInfo();
            startTimer();
        }

        function createGameBoard() {
            const container = document.getElementById('gameContainer');
            container.innerHTML = '';

            // åˆ›å»ºå‡åå¡ç‰‡ - ä½¿ç”¨éšæœºé¡ºåº
            const shuffledKanaPairs = shuffle([...currentPairs]);
            shuffledKanaPairs.forEach(pair => {
                const box = document.createElement('div');
                box.className = 'word-box';
                box.textContent = pair.kana;
                box.dataset.type = 'kana';
                box.dataset.pair = pair.kana + '|' + pair.meaning;
                
                // æ·»åŠ è§¦æ‘¸å’Œç‚¹å‡»äº‹ä»¶
                box.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    selectPair(this);
                });
                box.addEventListener('click', function() {
                    selectPair(this);
                });
                
                container.appendChild(box);
            });
            
            // åˆ›å»ºå«ä¹‰å¡ç‰‡ - ä½¿ç”¨å¦ä¸€ä¸ªéšæœºé¡ºåº
            const shuffledMeaningPairs = shuffle([...currentPairs]);
            shuffledMeaningPairs.forEach(pair => {
                const box = document.createElement('div');
                box.className = 'word-box';
                box.textContent = pair.meaning;
                box.dataset.type = 'meaning';
                box.dataset.pair = pair.kana + '|' + pair.meaning;
                
                // æ·»åŠ è§¦æ‘¸å’Œç‚¹å‡»äº‹ä»¶
                box.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    selectPair(this);
                });
                box.addEventListener('click', function() {
                    selectPair(this);
                });
                
                container.appendChild(box);
            });
        }

        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';

            // å®šä¹‰è¯¾ç¨‹å’Œå°ç»„çš„æ˜ å°„å…³ç³»
            const lessonNames = {
                'lesson7': 'ç¬¬7è¯¾',
                'lesson8': 'ç¬¬8è¯¾',
                'lesson9': 'ç¬¬9è¯¾'
            };
            const groupNames = {
                '1': 'å‘éŸ³å¯¹ç…§',
                '2': 'æ„æ€å¯¹ç…§',
                '3': 'æ··æ­'
            };

            // ä¸ºæ¯ä¸ªè¯¾ç¨‹å’Œå°ç»„ç»„åˆåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ’è¡Œæ¦œ
            for (const lessonKey in lessonNames) {
                for (const groupKey in groupNames) {
                    // ç­›é€‰å½“å‰è¯¾ç¨‹å’Œå°ç»„çš„è®°å½•
                    const filteredRecords = leaderboard.filter(record => 
                        record.lesson === lessonNames[lessonKey] && 
                        record.group === groupNames[groupKey]
                    );

                    // å¦‚æœæœ‰è®°å½•æ‰æ˜¾ç¤º
                    if (filteredRecords.length > 0) {
                        // åˆ›å»ºæ’è¡Œæ¦œåŒºåŸŸ
                        const section = document.createElement('div');
                        section.className = 'leaderboard-section';
                        
                        // æ·»åŠ æ ‡é¢˜
                        const title = document.createElement('div');
                        title.className = 'leaderboard-title';
                        title.textContent = `${lessonNames[lessonKey]} ${groupNames[groupKey]}ç»„`;
                        section.appendChild(title);
                        
                        // åˆ›å»ºåˆ—è¡¨
                        const ol = document.createElement('ol');
                        
                        // æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åºï¼Œåˆ†æ•°ç›¸åŒæ—¶ç”¨æ—¶å°‘çš„æ’åœ¨å‰é¢
                        const sortedScores = [...filteredRecords].sort((a, b) => {
                            if (b.score !== a.score) {
                                return b.score - a.score;
                            }
                            return a.timeUsed - b.timeUsed;
                        }).slice(0, 5); // åªæ˜¾ç¤ºå‰5å

                        sortedScores.forEach((record, index) => {
                            const li = document.createElement('li');
                            li.textContent = `${index + 1}. ${record.studentName}: ${record.score}åˆ†`;
                            ol.appendChild(li);
                        });

                        section.appendChild(ol);
                        leaderboardList.appendChild(section);
                    }
                }
            }

            if (leaderboardList.children.length === 0) {
                leaderboardList.innerHTML = '<div style="padding:10px;text-align:center;">æš‚æ— è®°å½•</div>';
            }
        }

        function saveScore() {
            try {
                const lessonNames = {
                    'lesson7': 'ç¬¬7è¯¾',
                    'lesson8': 'ç¬¬8è¯¾',
                    'lesson9': 'ç¬¬9è¯¾'
                };
                const groupNames = {
                    '1': 'å‘éŸ³å¯¹ç…§',
                    '2': 'æ„æ€å¯¹ç…§',
                    '3': 'æ··æ­'
                };

                // åœ¨ä¿å­˜å‰æ£€æŸ¥æ’è¡Œæ¦œå¤§å°ï¼Œé˜²æ­¢è¿‡å¤§
                if (leaderboard.length > 100) {
                    leaderboard = leaderboard.slice(-100); // ä¿ç•™æœ€è¿‘100æ¡è®°å½•
                }

                // è®¡ç®—ç”¨æ—¶ = æ€»æ—¶é—´ - å‰©ä½™æ—¶é—´
                const timeUsed = wordData[currentLesson].time - timeLeft;
                
                const newRecord = {
                    studentName: studentName,
                    score: score,
                    timeUsed: timeUsed,
                    lesson: lessonNames[currentLesson],
                    group: groupNames[currentGroup],
                    timestamp: new Date().getTime()
                };
                
                leaderboard.push(newRecord);
                localStorage.setItem('wordGameLeaderboard', JSON.stringify(leaderboard));
                updateLeaderboard();
            } catch (e) {
                console.error("ä¿å­˜åˆ†æ•°å¤±è´¥:", e);
            }
        }

        function clearLeaderboard() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’è¡Œæ¦œè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                leaderboard = [];
                localStorage.removeItem('wordGameLeaderboard');
                updateLeaderboard();
                alert('æ’è¡Œæ¦œå·²æ¸…ç©º');
            }
        }
            
        function gameSuccess() {
            clearInterval(timer);
            saveScore(); // æ¸¸æˆæˆåŠŸæ—¶ä¿å­˜æˆç»©
            alert(`${studentName} æˆåŠŸï¼å¾—åˆ†: ${score}`);
        }

        function gameOver() {
            clearInterval(timer);
            saveScore(); // æ¸¸æˆå¤±è´¥æ—¶ä¹Ÿä¿å­˜æˆç»©
            alert(`${studentName} æ™‚é–“åˆ‡ã‚Œï¼`);
        }

        function shuffle(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function selectPair(box) {
            if (box.classList.contains('matched')) return;
            
            box.classList.add('selected');
            selected.push(box);
            
            if (selected.length === 2) {
                const first = selected[0];
                const second = selected[1];
                
                // æ£€æŸ¥æ˜¯å¦ä¸€ä¸ªæ˜¯å‡åä¸€ä¸ªæ˜¯å«ä¹‰ï¼Œå¹¶ä¸”æ˜¯åŒä¸€å¯¹
                if (first.dataset.type !== second.dataset.type && 
                    first.dataset.pair === second.dataset.pair) {
                    selected.forEach(b => {
                        b.classList.add('matched');
                        b.classList.remove('selected');
                    });
                    score += 5;
                    updateScore();
                    checkGameComplete();
                } else {
                    selected.forEach(b => {
                        setTimeout(() => b.classList.remove('selected'), 500);
                    });
                }
                selected = [];
            }
        }

        function startTimer() {
            clearInterval(timer);
            document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}ç§’`;
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}ç§’`;
                if (timeLeft <= 0) gameOver();
            }, 1000);
        }

        function updateScore() {
            document.getElementById('score').textContent = `å¾—ç‚¹: ${score}`;
        }

        function updateLessonInfo() {
            const lessonNames = {
                'lesson7': 'ç¬¬7è¯¾',
                'lesson8': 'ç¬¬8è¯¾',
                'lesson9': 'ç¬¬9è¯¾'
            };
            document.getElementById('lessonInfo').textContent = 
                `${lessonNames[currentLesson]} ç¬¬${currentGroup}ç»„ å•è¯æ•°: ${currentPairs.length}`;
        }

        function checkGameComplete() {
            const matched = document.querySelectorAll('.matched').length;
            const total = document.querySelectorAll('.word-box').length;
            if (matched === total) {
                gameSuccess();
            }
        }

        function endGame() {
            clearInterval(timer);
            document.getElementById('gameContainer').innerHTML = '';
            document.getElementById('timer').textContent = 'æ®‹ã‚Šæ™‚é–“: 0ç§’';
        }
    </script>
</body>
</html>